# webex .deb update checker

name: Check for webex .deb updates
on:
  schedule:
    - cron: "0 15 * * 1"
  workflow_dispatch: {}
jobs:
  webex-bin-update-checker:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [dev]
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ matrix.branch }}
      - name: Setup tools
        run: |
          sudo apt update
          sudo apt install -y xmlstarlet libarchive-tools
      - name: Get previous .deb checksum
        id: prevdeb
        uses: mikefarah/yq@v4.28.2
        with:
          cmd: >
            yq '.modules[2].sources[0].sha256' com.cisco.Webex.yaml
      - name: Download latest .deb & get its metadata
        id: newdeb
        run: |
          curl -O https://binaries.webex.com/WebexDesktop-Ubuntu-Official-Package/Webex.deb
          SIZE=$(du -b Webex.deb | awk '{print $1}')
          CHECKSUM=$(sha256sum Webex.deb | awk '{print $1}')
          DATE=$(date +'%Y-%m-%d')
          VERSION=$(bsdtar -Oxf Webex.deb 'control.tar.gz' | bsdtar -Oxf - control | grep Version | awk '{print $2}')
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Update checksum & filesize in manifest yaml
        if: steps.prevdeb.outputs.result != steps.newdeb.outputs.checksum
        uses: mikefarah/yq@v4.28.2
        with:
          cmd: >
            yq -i '
              .modules[2].sources[0].sha256 = "${{ steps.newdeb.outputs.checksum }}" |
              .modules[2].sources[0].size = ${{ steps.newdeb.outputs.size }}
            ' com.cisco.Webex.yaml
      - name: Update version & release date in metainfo XML
        if: steps.prevdeb.outputs.result != steps.newdeb.outputs.checksum
        run: >
          xmlstarlet ed -L
          -i '/component/releases/release[1]' -t elem -n release
          -i '/component/releases/release[1]' -t attr -n version
          -v "${{ steps.newdeb.outputs.version }}"
          -i '/component/releases/release[1]' -t attr -n date
          -v "${{ steps.newdeb.outputs.date }}"
          com.cisco.Webex.metainfo.xml
      - name: Create pull request
        if: steps.prevdeb.outputs.result != steps.newdeb.outputs.checksum
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: webex-deb-update
          title: Update webex.deb to ${{ steps.newdeb.outputs.version }}
          body: This pull request was automatically generated by webex .deb updater. Please open an issue if you have any questions or complaints.
